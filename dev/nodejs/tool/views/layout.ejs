<!doctype html>
<html>
  <head>
    <title><%= title %></title>
    <meta charset="UTF-8">
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <style type="text/css">
      html, body, #map_canvas {
        margin: 0;
        padding: 0;
        height: 100%;
      }
    </style>
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="/javascripts/jquery-1.7.1.min.js"></script>
    <script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script>
      var map, result, marker = {};
      function initialize() {
        var myOptions = {
          zoom: 14,
          center: new google.maps.LatLng(35.661637000000, 139.66656000000),
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('map_canvas'), myOptions);

        // 地図表示後
        google.maps.event.addListener(map, 'tilesloaded', function() {
          bounds = map.getBounds()
          ne = bounds.getNorthEast();
          sw = bounds.getSouthWest();
          date = new Date();

          $.ajax({
              'data': {
                'begin': date.getHours() % 24,
                'end': (date.getHours() + 1) % 24,
                'date': 4,
                'ne': ne.lng() + ' ' + ne.lat(),
                'sw': sw.lng() + ' ' + sw.lat()
              },
              'type': 'GET',
              'url': 'http://localhost:3001/api',
            })
            .success(function(data) {
              result = data;
              move();
            });
        });
      }

      $(function() {
        google.maps.event.addDomListener(window, 'load', initialize);
        i = 0;
          var date = new Date();
          $('title').text(60 - date.getSeconds());

          var timerID = setTimeout(function() {
            clearTimeout(timerID);
            move();
            setInterval(move, 60000);
          }, (60 - date.getSeconds()) * 1000);
      });

      var move = function() {
        var date = new Date();
        $('title').text(date.getHours().toString().replace( /^([0-9])$/, '0$1') + date.getMinutes().toString().replace( /^([0-9])$/, '0$1'));
        var now = date.getHours().toString().replace( /^([0-9])$/, '0$1') + ':' + date.getMinutes().toString().replace( /^([0-9])$/, '0$1') + ':00';
        
        if (result[now] != undefined) {
          for (var stationId in marker) {
            marker[stationId].setMap(null);
          }

          marker = {};

          for (var i in result[now]) {
            // 駅IDごとにマーカーを作る
            marker[result[now][i]['station_id']] = new google.maps.Marker({
              icon: 'http://maps.google.co.jp/mapfiles/ms/icons/rail.png',
              map: map,
              position: new google.maps.LatLng(result[now][i]['lat'], result[now][i]['lng']),
              title: '<p>' + result[now][i]['name'] + '</p><p>' + result[now][i]['train'] + '</p>'
            });

            infoWindow = new google.maps.InfoWindow({
              position: new google.maps.LatLng(result[now][i]['lat'], result[now][i]['lng']),
              content: '<p>' + result[now][i]['name'] + '</p><p>' + result[now][i]['train'] + '</p>'
            });

            google.maps.event.addListener(marker[result[now][i]['station_id']], 'click', function() {
              infoWindow.open(map,  marker[result[now][i]['station_id']]);
            });
          }
        }
      };
//      var socket = io.connect('http://localhost:3000');
//      socket.on('news', function (data) {
//        alert(data);
//        socket.emit('my other event', { my: 'data' });
//      });
    </script>
  </head>
  <body>
  </head>
  <body>
  <%- body %>
  </body>
</html>
